{% extends 'base.html' %}

{% block content %}

<script>
    function showContent(event) {
	const parent = event.target.closest('div');
	const infoElement = parent.querySelector('.info');
	infoElement.classList.toggle("hidden");
    }
    function downloadFile(event, form_id) {
	jobID = window.location.href.split("/").at(-1);
	filename = `result${form_id}_aggregated.csv`;
	request_url = `/download/${jobID}/results/${filename}`;
	const link = document.createElement("a");
	link.href = request_url;
	link.download = `coral_${form_id}.csv`;
	link.click();
    }
</script>

{% if DEBUG %}
<div>
    <button class="text-xl border rounded-lg p-2 bg-indigo-100 hover:bg-indigo-200 mt-1 w-full text-left hover:cursor-pointer">
	DEVELOPMENT TOOLS (DON'T SHOW IN PRODUCTION)
    </button>
    <div class="space-y-2">
	<button class="bg-red-400 w-fit border p-2 rounded hover:cursor-pointer"
	    data-action="/dev/resubmit/{{ job_id }}"
	    onclick="sendRequest(event)">
	    RESUBMIT FORM
	</button>

	<button class="bg-red-400 w-fit border p-2 rounded hover:cursor-pointer"
	    data-action="/dev/reanalyze-plip/{{ job_id }}"
	    onclick="sendRequest(event)">
	    REANALYZE PLIP RESULTS
	</button>

	<button class="bg-red-400 w-fit border p-2 rounded hover:cursor-pointer"
	    data-action="/dev/redo-graphs/{{ job_id }}"
	    onclick="sendRequest(event)">
	    REDO GRAPHS
	</button>
    </div>

    <script>
	async function sendRequest(event) {
	    const url = event.target.getAttribute("data-action");
	    try {
		const res = await fetch(url, {
		    method: "POST",
		});
	    }
	    catch {
		console.log("DEVELOPER REQUEST FAILED!")
	    }
	    window.location.reload();
	}

    </script>
</div>
{% endif %}

<div>
    <button class="text-xl border rounded-lg p-2 bg-indigo-100 hover:bg-indigo-200 mt-1 w-full text-left hover:cursor-pointer" onclick="showContent(event)">
	Submission information
    </button>
    <div class="info p-2 text-lg border-x border-b border-dotted rounded-lg">
	Job ID: {{ job_id }}
    </div>
</div>

<div>
    <button class="text-xl border rounded-lg p-2 bg-indigo-100 hover:bg-indigo-200 mt-1 w-full text-left hover:cursor-pointer" onclick="showContent(event)">
	Simulation comparison
    </button>
    <div class="info p-2 text-lg border-x border-b border-dotted rounded-lg">
	TODO!
    </div>
</div>

<div id="details" class="text-lg">
    {% for run in runs_data %}
    <div class="flex-col items-center justify-center content-center">
	<div>
	    <button class="text-xl border rounded-lg p-2 bg-indigo-100 hover:bg-indigo-200 mt-1 w-full text-left hover:cursor-pointer" onclick="showContent(event)">
		{{run.filename }}
	    </button>
	    <div class="info px-2 pb-2 border-x border-b border-dotted rounded-lg">
		<button class="text-xl border rounded-lg p-2 bg-amber-100 hover:bg-amber-200 mt-1 text-left hover:cursor-pointer" onclick="downloadFile(event, {{ run.id }})">
		    Download simulation data
		</button>
		{{ name_VOI|default:"Value from experiment" }}: {{ run.value }} <br>
		<div>
		    <button class="text-xl border rounded-lg p-2 bg-indigo-100 hover:bg-indigo-200 mt-1 w-full text-left hover:cursor-pointer" onclick="showContent(event)">
			Interactions by frame
		    </button>
		    <div class="info p-2 text-lg border-x border-b border-dotted rounded-lg">
			{{ run.table|safe }}
		    </div>
		</div>
		<div>
		    <button class="text-xl border rounded-lg p-2 bg-indigo-100 hover:bg-indigo-200 mt-1 w-full text-left hover:cursor-pointer" onclick="showContent(event)">
			Overall interactions	
		    </button>
		    <div class="info p-2 text-lg border-x border-b border-dotted rounded-lg">
			{{ run.interaction_graph|safe }}
		    </div>
		</div>
		<div>
		    <button class="text-xl border rounded-lg p-2 bg-indigo-100 hover:bg-indigo-200 mt-1 w-full text-left hover:cursor-pointer" onclick="showContent(event)">
			Interaction map
		    </button>
		    <div class="info p-2 text-lg border-x border-b border-dotted rounded-lg">
			{{ run.map|safe }}
		    </div>
		</div>
		<div>
		    <button class="text-xl border rounded-lg p-2 bg-indigo-100 hover:bg-indigo-200 mt-1 w-full text-left hover:cursor-pointer" onclick="showContent(event)">
			Detected ligands
		    </button>
		    <div class="info p-2 text-lg border-x border-b border-dotted rounded-lg flex gap-2">
			{% for ligand in run.ligands %}
			<div class="bg-gray-300 w-fit p-2 rounded-lg">
			    <div class="border w-fit"> 
				{{ ligand.img|safe }}
			    </div>
			    Name: {{ ligand.name|default_if_none:"Unknown" }} <br>
			    {% if ligand.id  %}
			    ChEBI ID: <a href="https://www.ebi.ac.uk/chebi/searchId.do?chebiId=CHEBI:{{ ligand.id }}" class="hover:underline text-blue-600 inline">{{ ligand.id }}</a> <br>
			    {% else %}
			    ChEBI ID: Unknown <br>
			    {% endif %}
			    Detected in {{ ligand.frames_seen }} frame{{ ligand.frames_seen|pluralize }} <br>
			</div>
			{% endfor %}
		    </div>
		</div>
		<div>
		    <button class="text-xl border rounded-lg p-2 bg-indigo-100 hover:bg-indigo-200 mt-1 w-full text-left hover:cursor-pointer" onclick="showContent(event)">
			Protein numbering / alignment
		    </button>
		    <div class="info p-2 text-lg border-x border-b border-dotted rounded-lg flex gap-2">
			{% for chain, data in run.alignment_scores.items %}
			<div class="pt-1">
			    <strong>Chain {{ chain }}:</strong><br>
			    <p class="ml-2">Detected entry: <a href="https://www.uniprot.org/uniprotkb/{{ data.1 }}/entry" class="text-blue-700 underline-offset-2 underline">{{ data.0 }}</a></p>
			    <p class="ml-2">E-value: {{ data.2 }}</p>
			    <br>
			</div>
			{% endfor %}
		    </div>
		</div>
	    </div>
	</div>
    </div>
    {% endfor %}
</div>

{% endblock %}
